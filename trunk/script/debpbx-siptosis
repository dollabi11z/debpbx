#!/bin/bash
#
# debpbx-siptosis - 08/08/2010
#
# DebPBX-1.3.0
# Author: Federico Pereira <info@opentecnologic.com> & <fpereira@debpbx.org>
# Copyright 2008 Federico Pereira (LordBaseX)
# This script is licensed under GNU GPL version 2.0
#
#
#VARIABLES
ID_TRUNK=""
USER=""
PASS=""
EXTENSION=""
CPUINFO=`uname -a | grep 'amd64' | cut -d"-" -f3 | awk '{ print $1}'`
IP_ADRESS=`ifconfig eth0 | grep 'inet addr:' | cut -d: -f2 | awk '{ print $1}'`
source /etc/amportal.conf

clear
cat /etc/debpbx
echo "Author: Federico Pereira <fpereira@opentecnologic.com>"
echo "Copyright 2009 - Federico Pereira (LordBasex)"
echo "This Distro is licensed under GNU/GPL version 2.0"
echo "Web Site: www.debpbx.org"
echo ""
echo ""
echo "Will proceed to install the Skype integration with DebPBX."
echo "Data are needed to configure Skype account, username and password."
echo "You will also need the extension (internal) where enter the Skype call."
echo "but if not have a extension to cancel this with "control+c" and make extension"
echo "and then re-run this command: debpbx-siptosis"
echo ""
read -p "User Skype: " USER
read -p "Password Skype: " PASS
read -p "Extension DebPBX: " EXTENSION
echo ""
key=""
while [ "$key" != "y" ] && [ "$key" != "n" ];do
	clear
	echo ""
	echo "+----------------------------------------------------------------+"
	echo "| CONFIRM THAT THE INFORMATION IS CORRECT                        |"
	echo "+----------------------------------------------------------------+"
        echo ""
	echo "User Skype: $USER"
	echo "Passwoed Skype: $PASS"
	echo "Extension DebPBX: $EXTENSION"
	echo ""
	read -n 1 -p "Please confirm that the information is correct [y/N]" key
done
echo ""
echo ""
if [ $key == "y" ]; then
	#INSTALACIÓN DE PAQUETES Y LIBRERIAS
	aptitude update
	aptitude -y install xserver-xorg-video-fbdev xterm libqt4-dev libxss-dev x11proto-scrnsaver-dev xvfb elinks tightvncserver tightvnc-java  blackbox  
	#VERIFICADOR DE CPU
	#architecture=$CPUINFO
	if [ "$CPUINFO" == "amd64" ]; then
		aptitude install ia32-libs ia32-libs-gtk libqt4-core libqt4-gui
		dpkg -i  /var/www/pub/debpbx/modules/skype_2.1.0.81-1_amd64.deb
	else
		dpkg -i  /var/www/pub/debpbx/modules/skype_2.1.0.81-1_i386.deb
	fi

	aptitude -y install sun-java6-jdk

	#CREATE USER
	adduser stsuser --disabled-password --home /home/stsuser/ --gecos "stsuser SKYPE user" --force-badname
	adduser stsuser audio
        echo "stsuser:$(echo $PASS | openssl passwd -1 -stdin)" | chpasswd -e
        mkdir -p /home/stsuser/.vnc/
        chown -R stsuser:stsuser /home/stsuser/.vnc/

expect << EOF
spawn su -l stsuser -c "tightvncpasswd"
expect "*.vnc/passwd*"
expect "*assword:*"
send "${PASS}\r"
expect "*erify:*"
send "${PASS}\r"
expect "*Would you like to enter a view-only password (y/n)?*"
send "n\r"
expect eof;
EOF

	#SipToSis
	cp /var/www/pub/debpbx/modules/SipToSis_20100720.zip /usr/src/SipToSis_20100720.zip
	mkdir -p /home/stsuser/siptosis/
        cd /home/stsuser/siptosis/
	unzip /usr/src/SipToSis_20100720.zip
	chown stsuser:stsuser -R /home/stsuser/siptosis/
	cp /var/www/pub/debpbx/SkypeToSipAuth.props /home/stsuser/siptosis/SkypeToSipAuth.props
	sed -i "s/xx.xx.xx.xx/${IP_ADRESS}/g" "/home/stsuser/siptosis/SkypeToSipAuth.props"
	cp /var/www/pub/debpbx/stsTrunk_linux /home/stsuser/siptosis/stsTrunk_linux
	cp /home/stsuser/siptosis/stsTrunk_linux  /etc/init.d/siptosis
        chmod +x /etc/init.d/siptosis
	cp /home/stsuser/siptosis/samples/siptosis.cfg /home/stsuser/siptosis/siptosis.cfg
	chmod +x /home/stsuser/siptosis/stsTrunk_linux
	chmod +x /home/stsuser/siptosis/SipToSis_linux
	cp /var/www/pub/debpbx/rc.local /etc/rc.local



echo "

host_port=5070
contact_url=sip:123456789@127.0.0.1:5070
from_url=\"${USER}\" <sip:${USER}@127.0.0.1:5070>
username=${USER}
passwd=${PASS}
realm=127.0.0.1
" >> /home/stsuser/siptosis/siptosis.cfg

	#MYSQL INJECTION AND TRUNK EXTENSION
	echo "SELECT * FROM \`trunks\` WHERE \`trunkid\` ORDER BY trunkid DESC LIMIT 0,1;" | mysql -u${AMPDBUSER} -p${AMPDBPASS} -D${AMPDBNAME} | egrep -v "id" |  cut -f1 > /tmp/siptosip.tmp && ID_TRUNK=`cat /tmp/siptosip.tmp`
	ID_TRUNK=$(($ID_TRUNK+1))
	sed -i "s/IDXXX/${ID_TRUNK}/g" "/var/www/pub/debpbx/siptosis.sql"
	sed -i "s/USERXXX/${USER}/g" "/var/www/pub/debpbx/siptosis.sql"
	sed -i "s/PASSXXX/${PASS}/g" "/var/www/pub/debpbx/siptosis.sql"
	sed -i "s/EXTENSIONXXX/${EXTENSION}/g" "/var/www/pub/debpbx/siptosis.sql"
        mysql -u${AMPDBUSER} -p${AMPDBPASS} -D${AMPDBNAME} < /var/www/pub/debpbx/siptosis.sql
	/var/lib/asterisk/bin/module_admin reload
	echo ""
	echo ""
	echo "+----------------------------------------------------------------+"
	echo "| INSTALACION FINALIZADA CORRECTAMENTE                           |"
	echo "+----------------------------------------------------------------+"
        echo ""
	echo "Luego conectese con un cliente VNC para configurar su cuenta de Skype"
        echo "y acepte API skype4java a la ip: ${IP_ADRESS}:1"
        echo ""
        echo ""
        echo "Se procederá a reinicar el servidor en ... 10 segundo."
        echo "Si usted no quiere reiniciar presione control+z y reinícielo más tarde"
        echo "con el comando: shutdown -r now"
        sleep 10;
        shutdown -r now
else

	echo ""
	echo ""
	echo "Instalación abortada!!!"
	exit 1
fi
