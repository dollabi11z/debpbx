#!/bin/bash             
#                       
# debpbx-siptosis - 3/08/2010 
#                       
# DebPBX-1.3.0        
# Author: Federico Pereira <info@opentecnologic.com> & <fpereira@debpbx.org>
# Copyright 2008 Federico Pereira (LordBaseX)       
# This script is licensed under GNU GPL version 2.0 
#                                                   
#
#VARIABLES
USER=""
PASS=""
CPUINFO=`uname -a | grep 'amd64' | cut -d"-" -f3 | awk '{ print $1}'`
IP_ADRESS=`ifconfig eth0 | grep 'inet addr:' | cut -d: -f2 | awk '{ print $1}'` 

clear
cat /etc/debpbx
echo "Author: Federico Pereira <fpereira@opentecnologic.com>"
echo "Copyright 2009 - Federico Pereira (LordBasex)"
echo "This Distro is licensed under GNU/GPL version 2.0"
echo "Web Site: www.debpbx.org"
echo ""
echo ""
echo "Se prosedera a instalar la integración de Skype con DebPBX."
echo "Se necesita los datos de la cuenta a configurar Skype como usuario y clave."
echo ""
read -p "Usuario Skype: " USER
read -p "Clave: Skype:  " PASS
echo ""
key=""
while [ "$key" != "y" ] && [ "$key" != "n" ];do
	clear
	echo ""
	echo "+----------------------------------------------------------------+"
	echo "| CONFIRME QUE LOS DATOS SON CORRECTOS                           |"
	echo "+----------------------------------------------------------------+"
        echo ""
	echo "Usuario: $USER"
	echo "Clave:   $PASS"
	echo ""
	read -n 1 -p "Confirme que los datos son correctos? [y/N]" key
done
echo ""
echo ""
if [ $key == "y" ]; then
	
	#INSTALACIÓN DE PAQUETES Y LIBRERIAS
	aptitude update
	aptitude -y install xserver-xorg-video-fbdev xterm libqt4-dev libxss-dev x11proto-scrnsaver-dev xvfb elinks tightvncserver blackbox 

	#VERIFICADOR DE CPU
	#architecture=$CPUINFO
	if [ "$CPUINFO" == "amd64" ]; then
		aptitude install ia32-libs ia32-libs-gtk libqt4-core libqt4-gui
		wget http://debpbx.googlecode.com/svn/trunk/modules/skype_2.1.0.81-1_amd64.deb  -O /usr/src/skype_2.1.0.81-1_amd64.deb
	dpkg -i /usr/src/skype_2.1.0.81-1_amd64.deb
	else
    		echo "deb http://download.skype.com/linux/repos/debian/ stable non-free" >>  /etc/apt/sources.list
    		apt-key adv --keyserver pgp.mit.edu --recv-keys 0xd66b746e
    		aptitude update && aptitude install skype
	fi

	aptitude -y install sun-java6-jdk

	#CREATE USER
	adduser $USER --password PASSWORD
	echo "$USER:$PASS" | chpasswd --md5
 	usermod -a -G audio $USER

	#SipToSis
	wget http://debpbx.googlecode.com/svn/trunk/modules/SipToSis_20100720.zip -O /usr/src/SipToSis_20100720.zip
	mkdir -p /home/$USER/siptosis/
        cd /home/$USER/siptosis/
	unzip /usr/src/SipToSis_20100720.zip
	chown $USER:$USER -R /home/$USER/siptosis/
	wget http://debpbx.googlecode.com/svn/trunk/SkypeToSipAuth.props -O  /home/$USER/siptosis/SkypeToSipAuth.props
	wget http://debpbx.googlecode.com/svn/trunk/stsTrunk_linux -O  /home/$USER/siptosis/stsTrunk_linux
	sed -i "s/XXXXrunuser=stsuser/runuser=$USER/g" "/home/$USER/siptosis/stsTrunk_linux"
	cp /home/$USER/siptosis/samples/siptosis.cfg /home/$USER/siptosis/siptosis.cfg
	chmod +x /home/$USER/siptosis/stsTrunk_linux
	chmod +x /home/$USER/siptosis/SipToSis_linux
	wget http://debpbx.googlecode.com/svn/trunk/rc.local -O  /etc/rc.local

echo " 
host_port=5070
contact_url=sip:123456789@127.0.0.1:5070
from_url=\"${USER}\" <sip:${USER}@127.0.0.1:5070>
username=${USER}
passwd=${PASS}
realm=127.0.0.1
" >> /home/$USER/siptosis/siptosis.cfg

	#RUN
	sed -i "s/XXXXUSER/$USER/g" "/etc/rc.local"
	su -l $USER -c "/home/$USER/siptosis/stsTrunk_linux start"
	echo ""
	echo ""
	echo "+----------------------------------------------------------------+"
	echo "| INSTALACION FINALIZADA CORRECTAMENTE                           |"
	echo "+----------------------------------------------------------------+"
        echo ""
	echo "Conectese con un cliente VNC para logear su cuenta de Skype"  	
        echo "y aceptar API skype4java a la ip: ${IP_ADRESS}:1"


else

	echo ""
	echo ""
	echo "Instalación abortada!!!"
	exit 1
fi
