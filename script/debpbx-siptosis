#!/bin/bash             
#                       
# debpbx-siptosis - 15/11/2010 
#                       
# DebPBX-1.4       
# Author: Federico Pereira <info@opentecnologic.com> & <fpereira@debpbx.org>
# Copyright 2008 Federico Pereira (LordBaseX)       
# This script is licensed under GNU GPL version 2.0 
#                                                   

#VARIABLE
ID_TRUNK=""
EXTENSION=""
CPUINFO=`uname -a | grep 'amd64' | cut -d"-" -f3 | awk '{ print $1}'`
IP_ADRESS=`ifconfig eth0 | grep 'inet addr:' | cut -d: -f2 | awk '{ print $1}'`
source /etc/amportal.conf
data=$( tempfile 2>/dev/null )
trap "rm -f $data" 0 1 2 5 15

while [ 1 ]; do

dialog --backtitle "DebPBX - SipToSis - Part 1/4" --title "Enter User Name Skype" --inputbox "User Skype: " 8 60 2> $data
USER=`cat $data` 

	if [ "$(echo $USER)" != "" ]; then
		break;
	fi

done;

while [ 1 ]; do

# get password with the --insecure option
dialog --backtitle "DebPBX - SipToSis - Part 2/4"   --title "Password" \
--clear \
--insecure \
--passwordbox "Enter your password Skype" 10 35 2> $data
 
ret=$?

# make decison
case $ret in

  0)
    	PASS1=$(cat $data)
	;;
  1)
    	break;
	;
  255)
 	[ -s $data ] &&  cat $data || echo "ESC pressed.";
	;;

esac


dialog --backtitle "DebPBX - SipToSis - Part 3/4"   --title "Password" \
--clear \
--insecure \
--passwordbox "Re enter your password Skype" 10 35 2> $data

ret=$?

# make decison
case $ret in

  0)
        PASS2=$(cat $data)
        ;;
  1)
        break;
        ;;
  255)
        [ -s $data ] &&  cat $data || echo "ESC pressed.";
        ;;

esac


if [ "$PASS1" == "$PASS2" ]; then
	break;
else
	dialog --title "Info" --clear --msgbox "The passwords are diferent, lets again!" 10 41
fi

done

PASS="$PASS1"


while [ 1 ]; do

dialog --backtitle "DebPBX - SipToSis - Part 4/4" --title "Enter Extension Number Incoming Route Skype" --inputbox "Extension Number: " 8 60 2> $data
EXTENSION=`cat $data`

        if [ "$(echo $EXTENSION | grep '^[0-9]')"  != "" ]; then
                break;
        fi

done;

#################################################################################################################################
echo "1" | dialog --backtitle "DebPBX - SipToSis" --gauge "Repository Update" 10 70 0 >&2
aptitude update 2>&1
echo "3" | dialog --backtitle "DebPBX - SipToSis" --gauge "xserver-xorg-video-fbdev" 10 70 0 >&2
aptitude -y install xserver-xorg-video-fbdev 2>&1
echo "5" | dialog --backtitle "DebPBX - SipToSis" --gauge " xterm" 10 70 0 >&2
aptitude -y install xterm 2>&1
echo "7" | dialog --backtitle "DebPBX - SipToSis" --gauge "libqt4-dev" 10 70 0 >&2
aptitude -y install libqt4-dev 2>&1
echo "9" | dialog --backtitle "DebPBX - SipToSis" --gauge "libxss-dev" 10 70 0 >&2
aptitude -y install libxss-dev 2>&1
echo "11" | dialog --backtitle "DebPBX - SipToSis" --gauge "x11proto-scrnsaver-dev" 10 70 0 >&2
aptitude -y install x11proto-scrnsaver-dev 2>&1
echo "13" | dialog --backtitle "DebPBX - SipToSis" --gauge "xvfb" 10 70 0 >&2
aptitude -y install xvfb 2>&1
echo "15" | dialog --backtitle "DebPBX - SipToSis" --gauge "elinks" 10 70 0 >&2
aptitude -y install elinks 2>&1
echo "17" | dialog --backtitle "DebPBX - SipToSis" --gauge "tightvncserver" 10 70 0 >&2
aptitude -y install tightvncserver 2>&1
echo "19" | dialog --backtitle "DebPBX - SipToSis" --gauge "tightvnc-java" 10 70 0 >&2
aptitude -y install tightvnc-java 2>&1
echo "21" | dialog --backtitle "DebPBX - SipToSis" --gauge "blackbox" 10 70 0 >&2
aptitude -y install blackbox 2>&1
     
#CPU CHECKER
if [ "$CPUINFO" == "amd64" ]; then
		echo "36" | dialog --backtitle "DebPBX - SipToSis" --gauge "skype 64bit" 10 70 0 >&2
		aptitude -y install ia32-libs ia32-libs-gtk libqt4-core libqt4-gui 2>&1
		wget http://debpbx.googlecode.com/svn/trunk/modules/skype_2.1.0.81-1_amd64.deb -O  /var/cache/apt/archives/skype_2.1.0.81-1_amd64.deb 2>&1
		dpkg -i  /var/www/pub/debpbx/modules/skype_2.1.0.81-1_amd64.deb
	else
		echo "36" | dialog --backtitle "DebPBX - SipToSis" --gauge "skype 32bit" 10 70 0 >&2
 		wget http://debpbx.googlecode.com/svn/trunk/modules/skype_2.1.0.81-1_i386.deb -O /var/cache/apt/archives/skype_2.1.0.81-1_i386.deb 2>&1
		dpkg -i  /var/www/pub/debpbx/modules/skype_2.1.0.81-1_i386.deb 2>&1 
fi
echo "38" | dialog --backtitle "DebPBX - SipToSis" --gauge "sun-java6-jdk" 10 70 0 >&2
aptitude -y install sun-java6-jdk
echo "40" | dialog --backtitle "DebPBX - SipToSis" --gauge "installation SipToSis" 10 70 0 >&2
adduser stsuser --disabled-password --home /home/stsuser/ --gecos "stsuser SKYPE user" --force-badname
adduser stsuser audio
echo "stsuser:$(echo $PASS | openssl passwd -1 -stdin)" | chpasswd -e
mkdir -p /home/stsuser/.vnc/
chown -R stsuser:stsuser /home/stsuser/.vnc/
expect << EOF
spawn su -l stsuser -c "tightvncpasswd"
expect "*.vnc/passwd*"
expect "*assword:*"
send "${PASS}\r"
expect "*erify:*"
send "${PASS}\r"
expect "*Would you like to enter a view-only password (y/n)?*"
send "n\r"
expect eof;
EOF

echo "45" | dialog --backtitle "DebPBX - SipToSis" --gauge "Uncompressing temporary files" 10 70 0 >&2

#SipToSis
wget http://debpbx.googlecode.com/svn/trunk/modules/siptosis.tar.gz -O /usr/src/siptosis.tar.gz
cd /usr/src/
tar zxf /usr/src/siptosis.tar.gz
cd /usr/src/siptosis

mkdir -p /home/stsuser/siptosis/
cd /home/stsuser/siptosis/
unzip /usr/src/siptosis/SipToSis_*.zip
chown stsuser:stsuser -R /home/stsuser/siptosis/

#CONFIGURATION SkypeToSipAuth.props
cat > /home/stsuser/siptosis/SkypeToSipAuth.props << "EOF"
*,sip:123456789@${IP_ADRESS}:5060;dtmf:1365
*,play:clips/invalidDest.wav
EOF

#CONFIGURATION stsTrunk_linux
cp /usr/src/siptosis/stsTrunk_linux /home/stsuser/siptosis/stsTrunk_linux
chmod +x /home/stsuser/siptosis/stsTrunk_linux	        
	
#CONFIGURATION siptosis.cfg
cp /home/stsuser/siptosis/samples/siptosis.cfg /home/stsuser/siptosis/siptosis.cfg

echo "
host_port=5070
contact_url=sip:123456789@127.0.0.1:5070
from_url=\"${USER}\" <sip:${USER}@127.0.0.1:5070>
username=${USER}
passwd=${PASS}
realm=127.0.0.1
" >> /home/stsuser/siptosis/siptosis.cfg

#CONFIGURATION rc.local	
sed -i "s/exit 0/su -l stsuser -c \"\/home\/stsuser\/siptosis\/stsTrunk_linux start\"/g" "/etc/rc.local"
echo "exit 0" >> /etc/rc.local	

#CONFIGURATION FREEPBX
#MYSQL INJECTION AND TRUNK EXTENSION
echo "SELECT * FROM \`trunks\` WHERE \`trunkid\` ORDER BY trunkid DESC LIMIT 0,1;" | mysql -u${AMPDBUSER} -p${AMPDBPASS} -D${AMPDBNAME} | egrep -v "id" |  cut -f1 > /tmp/siptosip.tmp && ID_TRUNK=`cat /tmp/siptosip.tmp`

ID_TRUNK=$(($ID_TRUNK+1))
sed -i "s/IDXXX/${ID_TRUNK}/g" "/usr/src/siptosis/siptosis.sql"
sed -i "s/USERXXX/${USER}/g" "/usr/src/siptosis/siptosis.sql"
sed -i "s/PASSXXX/${PASS}/g" "/usr/src/siptosis/siptosis.sql"
sed -i "s/EXTENSIONXXX/${EXTENSION}/g" "/usr/src/siptosis/siptosis.sql"
mysql -u${AMPDBUSER} -p${AMPDBPASS} -D${AMPDBNAME} < /usr/src/siptosis/siptosis.sql
/var/lib/asterisk/bin/module_admin reload

sleep 1
echo "100" | dialog --backtitle "Complete" --gauge "DONE!" 10 70 0 >&2
#################################################################################################################################
sleep 1
dialog --backtitle "DebPBX - SipToSis"  
--title "Installation Successful" 
--clear 
--msgbox "Thanks for your time. This only runs one time per installation. Sorry for the inconvenience, try to reconnect to the console." 10 41


